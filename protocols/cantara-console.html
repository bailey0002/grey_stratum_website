<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Cantara Console | Grey Stratum</title>

    <link rel="icon" type="image/png" href="/my-favicon/favicon-96x96.png" sizes="96x96">
    <link rel="icon" type="image/svg+xml" href="/my-favicon/favicon.svg">
    <link rel="shortcut icon" href="/my-favicon/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="/my-favicon/apple-touch-icon.png">
    <link rel="manifest" href="/my-favicon/site.webmanifest">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500&family=Archivo:wght@300;400;500&family=Fira+Code:wght@400&display=swap" rel="stylesheet">

    <script>
        (function() {
            var saved = localStorage.getItem('theme');
            var prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            var theme = saved || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', theme);
        })();
        
        function toggleTheme() {
            var html = document.documentElement;
            var label = document.getElementById('themeLabel');
            if (html.getAttribute('data-theme') === 'dark') {
                html.setAttribute('data-theme', 'light');
                if (label) label.textContent = '[ LUX ]';
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                if (label) label.textContent = '[ NOX ]';
                localStorage.setItem('theme', 'dark');
            }
        }
    </script>

    <style>
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root, [data-theme="light"] {
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a1a1a;
            --text-secondary: #4a4f54;
            --text-muted: #5a6068;
            --text-faint: #7a818a;
            --gray-muted: #99ACB0;
            --border-color: #d8dce0;
            --border-light: #c8ccd0;
            --cyan-accent: #5BA4B5;
            --input-bg: #ffffff;
        }

        [data-theme="dark"] {
            --bg-primary: #1a1d21;
            --bg-secondary: #22272e;
            --bg-card: #22272e;
            --text-primary: #e6edf3;
            --text-secondary: #adbac7;
            --text-muted: #768390;
            --text-faint: #636e7b;
            --gray-muted: #768390;
            --border-color: #373e47;
            --border-light: #444c56;
            --cyan-accent: #5BA4B5;
            --input-bg: #2d333b;
        }

        html { background-color: var(--bg-primary); }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            font-weight: 300;
            min-height: 100vh;
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* ═══════════════════════════════════════════════════════════════
           PASSWORD GATE
           ═══════════════════════════════════════════════════════════════ */

        .password-gate {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .password-gate.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .gate-content {
            text-align: center;
            max-width: 400px;
            padding: 2rem;
        }

        .gate-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-family: 'Archivo', sans-serif;
            font-size: 1.2rem;
            font-weight: 300;
            letter-spacing: 0.3em;
            margin-bottom: 3rem;
        }

        .gate-logo .logo-grey { color: var(--gray-muted); }
        .gate-logo .logo-stratum { color: var(--text-primary); }

        .logo-gradus {
            display: flex;
            align-items: center;
            gap: 2px;
            margin: 0 0.6rem;
            height: 1.1em;
        }

        .gradus-bar {
            width: 2px;
            background-color: var(--cyan-accent);
            border-radius: 1px;
        }

        .gradus-bar:nth-child(1) { height: 40%; opacity: 0.5; }
        .gradus-bar:nth-child(2) { height: 65%; opacity: 0.75; }
        .gradus-bar:nth-child(3) { height: 90%; opacity: 1; }

        [data-theme="dark"] .gradus-bar:nth-child(1) { height: 90%; opacity: 1; }
        [data-theme="dark"] .gradus-bar:nth-child(2) { height: 65%; opacity: 0.75; }
        [data-theme="dark"] .gradus-bar:nth-child(3) { height: 40%; opacity: 0.5; }

        .gate-title {
            font-family: 'Fira Code', monospace;
            font-size: 0.65rem;
            letter-spacing: 0.15em;
            color: var(--cyan-accent);
            margin-bottom: 2rem;
        }

        .gate-input-container { margin-bottom: 2rem; }

        .gate-input {
            width: 100%;
            padding: 0.9rem 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            text-align: center;
            transition: border-color 0.3s ease;
        }

        .gate-input:focus {
            outline: none;
            border-color: var(--cyan-accent);
        }

        .gate-input::placeholder {
            color: var(--text-faint);
            letter-spacing: 0.15em;
        }

        .gate-error {
            font-family: 'Fira Code', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.1em;
            color: #CF6679;
            margin-top: 1rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .gate-error.visible { opacity: 1; }

        .gate-home {
            margin-top: 2rem;
        }

        .gate-home a {
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .gate-home a:hover { color: var(--cyan-accent); }

        /* ═══════════════════════════════════════════════════════════════
           CONSOLE CONTAINER
           ═══════════════════════════════════════════════════════════════ */

        .console-container {
            display: none;
            min-height: 100vh;
        }

        .console-container.visible { display: block; }

        /* Header */
        header {
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-primary);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .back-link {
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .back-link:hover { color: var(--cyan-accent); }

        .console-title {
            font-family: 'Archivo', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-primary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }

        .toggle-label {
            font-family: 'Fira Code', monospace;
            font-size: 0.55rem;
            letter-spacing: 0.15em;
            color: var(--text-faint);
            transition: color 0.3s ease;
        }

        .toggle-indicator {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .toggle-bar {
            width: 2px;
            background-color: var(--cyan-accent);
            border-radius: 1px;
        }

        .toggle-bar:nth-child(1) { height: 8px; opacity: 0.5; }
        .toggle-bar:nth-child(2) { height: 12px; opacity: 0.75; }
        .toggle-bar:nth-child(3) { height: 16px; opacity: 1; }

        [data-theme="dark"] .toggle-bar:nth-child(1) { height: 16px; opacity: 1; }
        [data-theme="dark"] .toggle-bar:nth-child(2) { height: 12px; opacity: 0.75; }
        [data-theme="dark"] .toggle-bar:nth-child(3) { height: 8px; opacity: 0.5; }

        .theme-toggle:hover .toggle-label { color: var(--cyan-accent); }

        /* ═══════════════════════════════════════════════════════════════
           MAIN LAYOUT
           ═══════════════════════════════════════════════════════════════ */

        main {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 1.5rem;
            padding: 1.5rem 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .section-label {
            font-family: 'Fira Code', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.15em;
            color: var(--text-faint);
            margin-bottom: 0.75rem;
        }

        /* Editor Section */
        .editor-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .text-editor {
            width: 100%;
            min-height: 200px;
            padding: 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            line-height: 1.7;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .text-editor:focus {
            outline: none;
            border-color: var(--cyan-accent);
        }

        .preview-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 1rem;
            min-height: 100px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .preview-content {
            white-space: pre-wrap;
            word-break: break-word;
        }

        /* Controls Panel */
        .controls-panel {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
        }

        .control-group {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            padding: 1rem;
        }

        .control-group-title {
            font-family: 'Fira Code', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.12em;
            color: var(--cyan-accent);
            margin-bottom: 0.75rem;
        }

        .control-row {
            margin-bottom: 0.75rem;
        }

        .control-row:last-child { margin-bottom: 0; }

        .control-label {
            display: block;
            font-size: 0.7rem;
            letter-spacing: 0.08em;
            color: var(--text-muted);
            margin-bottom: 0.35rem;
            text-transform: uppercase;
        }

        .control-input,
        .control-select {
            width: 100%;
            padding: 0.6rem 0.75rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.8rem;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: border-color 0.3s ease;
        }

        .control-input:focus,
        .control-select:focus {
            outline: none;
            border-color: var(--cyan-accent);
        }

        .control-select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23768390' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            padding-right: 2rem;
        }

        /* SSML Buttons */
        .ssml-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
        }

        .ssml-btn {
            padding: 0.5rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .ssml-btn:hover {
            border-color: var(--cyan-accent);
            color: var(--cyan-accent);
        }

        .ssml-btn.clear {
            grid-column: span 3;
            color: var(--text-faint);
        }

        /* Action Buttons */
        .action-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.75rem 1rem;
            font-family: 'Fira Code', monospace;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            border-color: var(--cyan-accent);
            color: var(--cyan-accent);
        }

        .btn--primary {
            background: var(--cyan-accent);
            border-color: var(--cyan-accent);
            color: #ffffff;
        }

        .btn--primary:hover {
            background: transparent;
            color: var(--cyan-accent);
        }

        /* Audio Player */
        audio {
            width: 100%;
            margin-top: 0.5rem;
            height: 36px;
        }

        /* ═══════════════════════════════════════════════════════════════
           STATUS BEACON
           ═══════════════════════════════════════════════════════════════ */

        .status-beacon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.6rem;
            padding: 0.6rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            font-family: 'Fira Code', monospace;
            font-size: 0.6rem;
            letter-spacing: 0.1em;
            text-transform: uppercase;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .beacon-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-faint);
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }

        .beacon-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            border: 1px solid transparent;
            opacity: 0;
        }

        .beacon-label {
            color: var(--text-faint);
            transition: color 0.3s ease;
        }

        /* State: IDLE */
        .status-beacon[data-state="idle"] .beacon-dot { background-color: var(--text-faint); }
        .status-beacon[data-state="idle"] .beacon-label { color: var(--text-faint); }

        /* State: CONNECTING - Amber */
        .status-beacon[data-state="connecting"] .beacon-dot {
            background-color: #D4A84B;
            box-shadow: 0 0 8px rgba(212, 168, 75, 0.6);
        }
        .status-beacon[data-state="connecting"] .beacon-dot::before {
            border-color: #D4A84B;
            opacity: 1;
            animation: pulse-ring 1.2s ease-out infinite;
        }
        .status-beacon[data-state="connecting"] .beacon-label { color: #D4A84B; }

        /* State: SYNTHESIZING - Cyan */
        .status-beacon[data-state="synthesizing"] .beacon-dot {
            background-color: var(--cyan-accent);
            box-shadow: 0 0 10px rgba(91, 164, 181, 0.7);
        }
        .status-beacon[data-state="synthesizing"] .beacon-dot::before {
            border-color: var(--cyan-accent);
            opacity: 1;
            animation: pulse-ring 0.8s ease-out infinite;
        }
        .status-beacon[data-state="synthesizing"] .beacon-label { color: var(--cyan-accent); }

        /* State: PLAYING - Green */
        .status-beacon[data-state="playing"] .beacon-dot {
            background-color: #4CAF7C;
            box-shadow: 0 0 12px rgba(76, 175, 124, 0.7);
        }
        .status-beacon[data-state="playing"] .beacon-label { color: #4CAF7C; }

        /* State: SUCCESS - Green */
        .status-beacon[data-state="success"] .beacon-dot {
            background-color: #4CAF7C;
            box-shadow: 0 0 15px rgba(76, 175, 124, 0.8);
        }
        .status-beacon[data-state="success"] .beacon-label { color: #4CAF7C; }

        /* State: ERROR - Rose */
        .status-beacon[data-state="error"] .beacon-dot {
            background-color: #CF6679;
            box-shadow: 0 0 10px rgba(207, 102, 121, 0.6);
        }
        .status-beacon[data-state="error"] .beacon-label { color: #CF6679; }

        @keyframes pulse-ring {
            0% { width: 8px; height: 8px; opacity: 0.9; }
            100% { width: 22px; height: 22px; opacity: 0; }
        }

        /* ═══════════════════════════════════════════════════════════════
           RESPONSIVE
           ═══════════════════════════════════════════════════════════════ */

        @media (max-width: 900px) {
            main {
                grid-template-columns: 1fr;
                padding: 1rem;
            }

            header {
                padding: 1rem;
                flex-direction: column;
                gap: 1rem;
            }

            .header-left {
                width: 100%;
                justify-content: space-between;
            }

            .ssml-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .ssml-btn.clear {
                grid-column: span 2;
            }
        }

        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }
    </style>
</head>
<body>

<!-- ═══════════════════════════════════════════════════════════════════
     PASSWORD GATE
     ═══════════════════════════════════════════════════════════════════ -->

<div class="password-gate" id="passwordGate">
    <div class="gate-content">
        <div class="gate-logo">
            <span class="logo-grey">GREY</span>
            <div class="logo-gradus">
                <div class="gradus-bar"></div>
                <div class="gradus-bar"></div>
                <div class="gradus-bar"></div>
            </div>
            <span class="logo-stratum">STRATUM</span>
        </div>
        
        <p class="gate-title">[ CANTARA CONSOLE — RESTRICTED ACCESS ]</p>
        
        <div class="gate-input-container">
            <input type="password" class="gate-input" id="passphraseInput" placeholder="Enter passphrase" autocomplete="off">
            <p class="gate-error" id="gateError">[ ACCESS DENIED ]</p>
        </div>
        
        <div class="gate-home">
            <a href="cantara.html">← Back to Cantara</a>
        </div>
    </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════
     MAIN CONSOLE
     ═══════════════════════════════════════════════════════════════════ -->

<div class="console-container" id="consoleContainer">
    <header>
        <div class="header-left">
            <a href="cantara.html" class="back-link">← Back to Cantara</a>
            <span class="console-title">TTS+ Console</span>
        </div>
        <div class="header-right">
            <div class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">
                <span class="toggle-label" id="themeLabel">[ NOX ]</span>
                <div class="toggle-indicator">
                    <div class="toggle-bar"></div>
                    <div class="toggle-bar"></div>
                    <div class="toggle-bar"></div>
                </div>
            </div>
        </div>
    </header>

    <main>
        <!-- LEFT: Editor -->
        <div class="editor-section">
            <div>
                <p class="section-label">[ TEXT INPUT ]</p>
                <textarea class="text-editor" id="textEditor" placeholder="Enter text to synthesize...">Welcome to Cantara. This is a demonstration of neural text-to-speech synthesis.</textarea>
            </div>
            
            <div>
                <p class="section-label">[ SSML PREVIEW ]</p>
                <div class="preview-section">
                    <div class="preview-content" id="ssmlPreview">Welcome to Cantara. This is a demonstration of neural text-to-speech synthesis.</div>
                </div>
            </div>
        </div>

        <!-- RIGHT: Controls -->
        <div class="controls-panel">
            <!-- Azure Credentials -->
            <div class="control-group">
                <p class="control-group-title">[ AZURE CREDENTIALS ]</p>
                <div class="control-row">
                    <label class="control-label">API Key</label>
                    <input type="password" class="control-input" id="apiKey" placeholder="Enter Azure Speech key">
                </div>
                <div class="control-row">
                    <label class="control-label">Region</label>
                    <input type="text" class="control-input" id="region" placeholder="e.g., eastus">
                </div>
            </div>

            <!-- Voice Selection -->
            <div class="control-group">
                <p class="control-group-title">[ VOICE ]</p>
                <div class="control-row">
                    <label class="control-label">Neural Voice</label>
                    <select class="control-select" id="voiceSelect">
                        <option value="en-US-JennyNeural">Jenny (US)</option>
                        <option value="en-US-GuyNeural">Guy (US)</option>
                        <option value="en-US-AriaNeural">Aria (US)</option>
                        <option value="en-US-DavisNeural">Davis (US)</option>
                        <option value="en-GB-SoniaNeural">Sonia (UK)</option>
                        <option value="en-GB-RyanNeural">Ryan (UK)</option>
                        <option value="en-AU-NatashaNeural">Natasha (AU)</option>
                    </select>
                </div>
                <div class="control-row">
                    <label class="control-label">Output Format</label>
                    <select class="control-select" id="formatSelect">
                        <option value="audio-24khz-96kbitrate-mono-mp3">MP3 (24kHz)</option>
                        <option value="audio-48khz-192kbitrate-mono-mp3">MP3 (48kHz HQ)</option>
                        <option value="riff-24khz-16bit-mono-pcm">WAV (24kHz)</option>
                    </select>
                </div>
            </div>

            <!-- SSML Effects -->
            <div class="control-group">
                <p class="control-group-title">[ SSML EFFECTS ]</p>
                <div class="ssml-buttons">
                    <button class="ssml-btn" onclick="applySSML('emphasis')">Emphasis</button>
                    <button class="ssml-btn" onclick="applySSML('break')">Break</button>
                    <button class="ssml-btn" onclick="applySSML('prosody')">Prosody</button>
                    <button class="ssml-btn" onclick="applySSML('pitch')">Pitch</button>
                    <button class="ssml-btn" onclick="applySSML('rate')">Rate</button>
                    <button class="ssml-btn clear" onclick="clearSSML()">Clear All</button>
                </div>
            </div>

            <!-- Actions -->
            <div class="control-group">
                <p class="control-group-title">[ ACTIONS ]</p>
                <div class="action-group">
                    <button class="btn btn--primary" id="synthesizeBtn" onclick="synthesize()">▶ Synthesize</button>
                    <button class="btn" id="downloadBtn" onclick="synthesize(true)">↓ Download</button>
                </div>
                <audio id="audioPlayer" controls style="display: none;"></audio>
                
                <!-- STATUS BEACON -->
                <div class="status-beacon" id="statusBeacon" data-state="idle">
                    <span class="beacon-dot"></span>
                    <span class="beacon-label">Ready</span>
                </div>
            </div>
        </div>
    </main>
</div>

<script>
    // ═══════════════════════════════════════════════════════════════════
    // PASSWORD GATE
    // ═══════════════════════════════════════════════════════════════════
    
    const PASSPHRASE = 'stratum0304';
    const PASSPHRASE_HASH = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918'; // SHA-256 of passphrase
    
    function checkSession() {
        if (sessionStorage.getItem('cantara_access') === 'granted') {
            grantAccess();
        }
    }
    
    function grantAccess() {
        document.getElementById('passwordGate').classList.add('hidden');
        document.getElementById('consoleContainer').classList.add('visible');
        sessionStorage.setItem('cantara_access', 'granted');
        loadCredentials();
        initThemeLabel();
    }
    
    function initThemeLabel() {
        const theme = document.documentElement.getAttribute('data-theme');
        const label = document.getElementById('themeLabel');
        if (label) label.textContent = theme === 'dark' ? '[ NOX ]' : '[ LUX ]';
    }
    
    document.getElementById('passphraseInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const input = this.value.trim().toLowerCase();
            if (input === PASSPHRASE) {
                grantAccess();
            } else {
                document.getElementById('gateError').classList.add('visible');
                this.value = '';
                setTimeout(() => {
                    document.getElementById('gateError').classList.remove('visible');
                }, 2000);
            }
        }
    });
    
    // ═══════════════════════════════════════════════════════════════════
    // CREDENTIAL PERSISTENCE
    // ═══════════════════════════════════════════════════════════════════
    
    function saveCredentials() {
        localStorage.setItem('cantara_apiKey', document.getElementById('apiKey').value);
        localStorage.setItem('cantara_region', document.getElementById('region').value);
    }
    
    function loadCredentials() {
        const savedKey = localStorage.getItem('cantara_apiKey');
        const savedRegion = localStorage.getItem('cantara_region');
        if (savedKey) document.getElementById('apiKey').value = savedKey;
        if (savedRegion) document.getElementById('region').value = savedRegion;
    }
    
    document.getElementById('apiKey').addEventListener('change', saveCredentials);
    document.getElementById('region').addEventListener('change', saveCredentials);
    
    // ═══════════════════════════════════════════════════════════════════
    // STATUS BEACON CONTROLLER
    // ═══════════════════════════════════════════════════════════════════
    
    const StatusBeacon = {
        element: null,
        labelElement: null,
        
        states: {
            idle:         { label: 'Ready' },
            connecting:   { label: 'Connecting...' },
            synthesizing: { label: 'Synthesizing...' },
            playing:      { label: 'Playing' },
            success:      { label: 'Complete' },
            error:        { label: 'Error' }
        },
        
        init() {
            this.element = document.getElementById('statusBeacon');
            this.labelElement = this.element?.querySelector('.beacon-label');
        },
        
        setState(state) {
            if (!this.element) this.init();
            if (!this.element) return;
            
            this.element.setAttribute('data-state', state);
            if (this.labelElement && this.states[state]) {
                this.labelElement.textContent = this.states[state].label;
            }
        },
        
        setCustom(state, label) {
            this.setState(state);
            if (this.labelElement) {
                this.labelElement.textContent = label;
            }
        },
        
        idle()         { this.setState('idle'); },
        connecting()   { this.setState('connecting'); },
        synthesizing() { this.setState('synthesizing'); },
        playing()      { this.setState('playing'); },
        success()      { 
            this.setState('success'); 
            setTimeout(() => this.idle(), 2500);
        },
        error(msg)     { 
            this.setCustom('error', msg || 'Error');
            setTimeout(() => this.idle(), 4000);
        }
    };
    
    // ═══════════════════════════════════════════════════════════════════
    // SSML FUNCTIONS
    // ═══════════════════════════════════════════════════════════════════
    
    const textEditor = document.getElementById('textEditor');
    const ssmlPreview = document.getElementById('ssmlPreview');
    
    function updatePreview() {
        ssmlPreview.textContent = textEditor.value;
    }
    
    function applySSML(effect) {
        const start = textEditor.selectionStart;
        const end = textEditor.selectionEnd;
        const selectedText = textEditor.value.substring(start, end);
        
        if (!selectedText) {
            StatusBeacon.setCustom('error', 'Select text first');
            setTimeout(() => StatusBeacon.idle(), 2000);
            return;
        }
        
        let wrapped = '';
        switch(effect) {
            case 'emphasis':
                wrapped = `<emphasis level="strong">${selectedText}</emphasis>`;
                break;
            case 'break':
                wrapped = `${selectedText}<break time="500ms"/>`;
                break;
            case 'prosody':
                wrapped = `<prosody rate="slow" pitch="low">${selectedText}</prosody>`;
                break;
            case 'pitch':
                wrapped = `<prosody pitch="+10%">${selectedText}</prosody>`;
                break;
            case 'rate':
                wrapped = `<prosody rate="slow">${selectedText}</prosody>`;
                break;
        }
        
        textEditor.value = textEditor.value.substring(0, start) + wrapped + textEditor.value.substring(end);
        updatePreview();
    }
    
    function clearSSML() {
        const cleaned = textEditor.value
            .replace(/<emphasis[^>]*>|<\/emphasis>/gi, '')
            .replace(/<break[^>]*\/>/gi, '')
            .replace(/<prosody[^>]*>|<\/prosody>/gi, '');
        textEditor.value = cleaned;
        updatePreview();
    }
    
    textEditor.addEventListener('input', updatePreview);
    
    // ═══════════════════════════════════════════════════════════════════
    // SYNTHESIS
    // ═══════════════════════════════════════════════════════════════════
    
    const audioPlayer = document.getElementById('audioPlayer');
    
    async function synthesize(download = false) {
        const apiKey = document.getElementById('apiKey').value.trim();
        const region = document.getElementById('region').value.trim();
        const voice = document.getElementById('voiceSelect').value;
        const format = document.getElementById('formatSelect').value;
        const text = textEditor.value.trim();
        
        // Validation
        if (!apiKey || !region) {
            StatusBeacon.error('Missing credentials');
            return;
        }
        if (!text) {
            StatusBeacon.error('No text input');
            return;
        }
        
        saveCredentials();
        
        // Build SSML
        const ssml = `<speak version="1.0" xmlns="http://www.w3.org/2001/10/synthesis" xml:lang="en-US">
            <voice name="${voice}">${text}</voice>
        </speak>`;
        
        // === BEGIN SYNTHESIS ===
        StatusBeacon.connecting();
        
        try {
            StatusBeacon.synthesizing();
            
            const response = await fetch(`https://${region}.tts.speech.microsoft.com/cognitiveservices/v1`, {
                method: 'POST',
                headers: {
                    'Ocp-Apim-Subscription-Key': apiKey,
                    'Content-Type': 'application/ssml+xml',
                    'X-Microsoft-OutputFormat': format,
                    'User-Agent': 'Cantara-TTS/1.0'
                },
                body: ssml
            });
            
            if (!response.ok) {
                StatusBeacon.error(`HTTP ${response.status}`);
                console.error('Synthesis error:', response.status, response.statusText);
                return;
            }
            
            const audioBlob = await response.blob();
            const audioUrl = URL.createObjectURL(audioBlob);
            
            if (download) {
                const ext = format.includes('mp3') ? 'mp3' : 'wav';
                const a = document.createElement('a');
                a.href = audioUrl;
                a.download = `Cantara_TTS_${Date.now()}.${ext}`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                StatusBeacon.success();
            } else {
                audioPlayer.src = audioUrl;
                audioPlayer.style.display = 'block';
                audioPlayer.play().catch(() => StatusBeacon.error('Playback failed'));
                StatusBeacon.playing();
                
                audioPlayer.onended = () => StatusBeacon.idle();
                audioPlayer.onpause = () => {
                    if (audioPlayer.currentTime >= audioPlayer.duration - 0.1) {
                        StatusBeacon.idle();
                    }
                };
            }
            
        } catch (err) {
            StatusBeacon.error('Network error');
            console.error('Synthesis fetch error:', err);
        }
    }
    
    // ═══════════════════════════════════════════════════════════════════
    // INIT
    // ═══════════════════════════════════════════════════════════════════
    
    checkSession();
    StatusBeacon.init();
    updatePreview();
</script>

</body>
</html>
